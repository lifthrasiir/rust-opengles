VPATH=%VPATH%

RUSTC ?= rustc
RUSTFLAGS ?=

ifeq ($(shell uname -s),Darwin)
ifeq ($(shell sw_vers | grep -c 10.6),1)
RUSTFLAGS += --cfg mac_10_6
endif
ifeq ($(shell sw_vers | grep -c 10.7),1)
RUSTFLAGS += --cfg mac_10_7
endif
else
endif

ifneq (,$(findstring MINGW,$(shell uname -s)))
ABI = stdcall
ANGLE_SRC = $(VPATH)/angle/src
ANGLE_DLLS = libGLESv2.dll libEGL.dll
ANGLE_CLEAN = angle-clean
else
ABI = cdecl
ANGLE_SRC =
ANGLE_DLLS =
ANGLE_CLEAN =
endif

RUST_SRC=$(shell find $(VPATH)/. -type f -name '*.rs')

.PHONY: all
all:    libopengles.dummy

%.o:	%.c
	$(CC) $< -o $@ -c $(CFLAGS)

libopengles.dummy: lib.rs $(RUST_SRC) $(ANGLE_DLLS)
	$(RUSTC) $(RUSTFLAGS) $< --lib --out-dir .
	touch $@

ifneq ($(ANGLE_SRC),)
libEGL.dll: $(ANGLE_SRC)/libEGL.dll
	cp $< $@
libGLESv2.dll: $(ANGLE_SRC)/libGLESv2.dll
	cp $< $@
$(ANGLE_SRC)/libEGL.dll:
	cd $(ANGLE_SRC) && $(MAKE) libEGL.dll
$(ANGLE_SRC)/libGLESv2.dll:
	cd $(ANGLE_SRC) && $(MAKE) libGLESv2.dll
endif

opengles-test: lib.rs $(RUST_SRC)
	$(RUSTC) $(RUSTFLAGS) $< -o $@ --test

.PHONY: check
check: opengles-test
	./opengles-test $(TEST)

.PHONY: clean angle-clean
clean: $(ANGLE_CLEAN)
	rm -f *.o *.a *.so *.dylib *.dll *.dummy *-test
angle-clean:
	cd $(ANGLE_SRC) && $(MAKE) clean
